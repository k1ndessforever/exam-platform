generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  passwordHash  String
  name          String
  mobile        String?
  examType      String?
  role          String        @default("student")
  isActive      Boolean       @default(true)
  emailVerified Boolean       @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  examAttempts  ExamAttempt[]
  sessions      Session[]
  
  @@index([email])
  @@index([role])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Exam {
  id                      String   @id @default(uuid())
  name                    String
  description             String?
  examType                String
  durationMinutes         Int      @default(120)
  totalQuestions          Int      @default(100)
  
  difficultyDistribution  Json
  subjectDistribution     Json
  
  correctMarks            Decimal  @default(4)
  wrongMarks              Decimal  @default(-1)
  unattemptedMarks        Decimal  @default(0)
  
  isActive                Boolean  @default(true)
  isPublished             Boolean  @default(false)
  startDate               DateTime?
  endDate                 DateTime?
  maxAttempts             Int      @default(3)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  createdBy               String?
  
  examQuestions           ExamQuestion[]
  examAttempts            ExamAttempt[]
  
  @@index([examType])
  @@index([isActive, isPublished])
  @@index([startDate, endDate])
}

model Question {
  id              String   @id @default(uuid())
  questionText    String   @db.Text
  optionA         String   @db.Text
  optionB         String   @db.Text
  optionC         String   @db.Text
  optionD         String   @db.Text
  correctOption   String
  explanation     String?  @db.Text
  
  subject         String
  topic           String
  subtopic        String?
  difficulty      String
  
  hasDiagram      Boolean  @default(false)
  diagramId       String?  @unique
  
  timesAsked      Int      @default(0)
  timesCorrect    Int      @default(0)
  averageTime     Int?
  
  isActive        Boolean  @default(true)
  isVerified      Boolean  @default(false)
  source          String?
  year            Int?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  
  diagram         Diagram?  @relation(fields: [diagramId], references: [id], onDelete: SetNull)
  examQuestions   ExamQuestion[]
  attemptAnswers  AttemptAnswer[]
  
  @@index([subject, difficulty])
  @@index([topic, subtopic])
  @@index([isActive, isVerified])
}

model Diagram {
  id          String   @id @default(uuid())
  filename    String
  filePath    String   @unique
  altText     String?
  width       Int?
  height      Int?
  fileSizeKb  Int?
  mimeType    String   @default("image/png")
  
  uploadedAt  DateTime @default(now())
  uploadedBy  String?
  
  question    Question?
  
  @@index([filePath])
}

model ExamQuestion {
  id          String   @id @default(uuid())
  examId      String
  questionId  String
  position    Int?
  weight      Decimal?
  
  addedAt     DateTime @default(now())
  addedBy     String?
  
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@unique([examId, questionId])
  @@index([examId])
  @@index([questionId])
}

model ExamAttempt {
  id              String    @id @default(uuid())
  userId          String
  examId          String
  attemptNumber   Int       @default(1)
  
  questionIds     String[]
  
  startedAt       DateTime  @default(now())
  submittedAt     DateTime?
  timeSpentSeconds Int?
  
  isCompleted     Boolean   @default(false)
  isAbandoned     Boolean   @default(false)
  
  ipAddress       String?
  userAgent       String?
  deviceInfo      Json?
  
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam            Exam              @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers         AttemptAnswer[]
  result          AttemptResult?
  
  @@unique([userId, examId, attemptNumber])
  @@index([userId, examId])
  @@index([startedAt])
  @@index([isCompleted])
}

model AttemptAnswer {
  id                  String    @id @default(uuid())
  attemptId           String
  questionId          String
  
  selectedOption      String?
  isMarkedForReview   Boolean   @default(false)
  timeSpentSeconds    Int       @default(0)
  
  answeredAt          DateTime?
  lastModifiedAt      DateTime  @updatedAt
  
  attempt             ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question            Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@unique([attemptId, questionId])
  @@index([attemptId])
}

model AttemptResult {
  id              String   @id @default(uuid())
  attemptId       String   @unique
  
  totalQuestions  Int
  attempted       Int
  correct         Int
  wrong           Int
  unattempted     Int
  
  totalScore      Decimal
  maxScore        Decimal
  accuracy        Decimal
  
  percentile      Decimal?
  rank            Int?
  totalAttempts   Int?
  
  subjectScores   Json?
  
  averageTimePerQuestion Int?
  
  calculatedAt    DateTime @default(now())
  
  attempt         ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  
  @@index([percentile])
  @@index([rank])
  @@index([totalScore])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  entityType  String
  entityId    String
  metadata    Json?
  ipAddress   String?
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}